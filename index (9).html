<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RK Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; }
        body { 
            background-color: #111827; 
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.1); border-radius: 20px; }
        .dark ::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.1); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes pulseGlow { 0% { box-shadow: 0 0 0 0 rgba(255,255,255, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255,255,255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255,255,255, 0); } }
        .animate-salepage { animation: pulseGlow 2s infinite; }

        
            .bubble-doodle-bot { border-radius: 18px 18px 18px 4px !important; border: 2px solid #111b21; transform: rotate(-1.5deg); }
            .bubble-doodle-user { border-radius: 18px 18px 4px 18px !important; border: 2px solid #111b21; transform: rotate(1deg); }
        

        /* Modal Styles */
        .modal-overlay { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        .modal-content { background-color: #1f2937; color: #f9fafb; }
        .form-input { 
            background-color: color-mix(in srgb, #f9fafb, transparent 95%); 
            color: #f9fafb; 
            border-color: color-mix(in srgb, #f9fafb, transparent 80%);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#00a884',
                        'bot-bubble': '#ffffff',
                        'bot-text': '#111b21',
                        'user-bubble': '#00a884',
                        'user-text': '#111b21',
                    }
                }
            }
        }
    </script>
</head>
<body class="flex flex-col h-[100dvh] overflow-hidden">
    
    <!-- HEADER -->
    <header class="flex-shrink-0 px-4 py-3 shadow-md z-20 flex items-center gap-3" style="background-color: #008069; color: #ffffff;">
        <div class="h-10 w-10 bg-white/20 rounded-full flex items-center justify-center overflow-hidden border border-white/10">
            <img src="https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/Avatar.webp" class="w-full h-full object-cover">
        </div>
        <div>
            <h1 class="font-bold text-lg leading-tight">RK Chat</h1>
            <div class="flex items-center gap-1.5 opacity-80 text-xs">
                <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                <span>Online</span>
            </div>
        </div>
        
    </header>

    <!-- MAIN WRAPPER WITH WALLPAPER -->
    <div class="flex-grow flex flex-col relative overflow-hidden" style="background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: cover; background-position: center;">
        
        <!-- CHAT AREA -->
        <main id="chat-body" class="flex-grow overflow-y-auto p-4 space-y-4 relative scroll-smooth bg-transparent">
            <!-- Messages injected here -->
            <div class="h-4"></div> <!-- Spacer -->
        </main>

        <!-- QUICK REPLIES (Horizontal Scroll) -->
        <div id="quick-replies" class="flex-shrink-0 overflow-x-auto whitespace-nowrap px-4 py-2 gap-2 flex hide-scrollbar z-10 min-h-[40px]"></div>
    </div>

    <!-- FOOTER INPUT -->
    <footer class="flex-shrink-0 p-3 z-20" style="background-color: #1f2937; border-top: 1px solid #374151;">
        <div class="flex items-center gap-2 max-w-4xl mx-auto rounded-full px-1 py-1 transition-all shadow-inner" style="background-color: #374151; border: 1px solid #4b5563; color: #f9fafb;">
            <input type="text" id="user-input" placeholder="Taip mesej anda..." class="flex-grow bg-transparent px-4 py-2.5 outline-none text-[16px] placeholder-gray-400" style="color: inherit;" autocomplete="off">
            <button id="send-btn" class="h-10 w-10 bg-primary text-white rounded-full flex items-center justify-center shadow-md hover:scale-105 active:scale-95 transition-transform">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 ml-1"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>
            </button>
        </div>
    </footer>

    <!-- INTRO FORM MODAL -->
    <div id="variable-modal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4 animate-fade-in">
        <div class="modal-content w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-4 bg-primary text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg">Maklumat Diri</h3>
                <button onclick="document.getElementById('variable-modal').classList.remove('flex'); document.getElementById('variable-modal').classList.add('hidden');" class="p-1 hover:bg-white/20 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <form id="variable-form" class="p-5 space-y-4 overflow-y-auto">
                
                <div>
                    <label class="block text-xs font-bold uppercase tracking-wide opacity-70 mb-1">Nama</label>
                    <input type="text" name="name" required placeholder="Boleh saya dapatkan nama anda?" class="form-input w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                </div>
                <button type="submit" class="w-full py-3.5 bg-primary text-white font-bold rounded-xl shadow-lg hover:brightness-110 active:scale-95 transition-all mt-2">HANTAR MAKLUMAT</button>
            </form>
        </div>
    </div>

    <!-- CHECKOUT MODAL -->
    <div id="checkout-modal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4 animate-fade-in">
        <div class="modal-content w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-4 bg-primary text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg">Borang Tempahan</h3>
                <button onclick="document.getElementById('checkout-modal').classList.remove('flex'); document.getElementById('checkout-modal').classList.add('hidden');" class="p-1 hover:bg-white/20 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="overflow-y-auto p-5 space-y-4">
                
                <div class="bg-black/5 p-3 rounded-lg text-xs whitespace-pre-wrap border border-black/10 opacity-80">Maybank: (ARG EMPIRE)</div>
                <div class="flex justify-center"><img src="https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/ARG%20QR.webp" class="max-w-[150px] rounded-lg border shadow-sm"></div>
                
                <form id="checkout-form-inner" class="space-y-3">
                    <input type="hidden" id="checkout_product_name" name="product" value="">
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wide opacity-70 mb-1">Nama Penuh</label>
                        <input type="text" name="name" required class="form-input w-full px-4 py-2 rounded-lg border outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wide opacity-70 mb-1">No Telefon</label>
                        <input type="tel" name="phone" required class="form-input w-full px-4 py-2 rounded-lg border outline-none">
                    </div>
                     <div>
                        <label class="block text-xs font-bold uppercase tracking-wide opacity-70 mb-1">Alamat / Nota</label>
                        <textarea name="address" rows="2" class="form-input w-full px-4 py-2 rounded-lg border outline-none"></textarea>
                    </div>
                    <button type="submit" class="w-full py-3 bg-primary text-white font-bold rounded-xl shadow-lg hover:brightness-110 active:scale-95 transition-all mt-2">SAHKAN TEMPAHAN</button>
                </form>
                
            </div>
        </div>
    </div>

    

    <script>
    
    /* === KONFIGURASI === */
    const CONFIG = {
        deploymentType: "static_js",
        enableStaticApi: false,
        apiKeys: ["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"],
        model: "llama-3.1-8b-instant",
        botName: "RK Chat",
        welcomeMessage: "Helo {{name}}, Ada apa-apa yang boleh saya bantu?",
        variableCollectionStyle: "form",
        variables: [
  {
    "id": 1,
    "variableKey": "name",
    "label": "Nama",
    "enabled": true,
    "question": "Boleh saya dapatkan nama anda?",
    "allowMultiple": false
  }
],
        variableIntro: "Hai Assalamualaikum, dan salam sejahtera",
        introButtons: [
  {
    "id": 1762353474536,
    "label": "salepage premium",
    "url": ""
  },
  {
    "id": 1762353487216,
    "label": "biolink premium",
    "url": ""
  },
  {
    "id": 1762353492826,
    "label": "Chatbot Ai",
    "url": ""
  },
  {
    "id": 1762353507680,
    "label": "Servis Design",
    "url": ""
  }
],
        autoResponderRules: [
  {
    "id": 1764945300015.6758,
    "keyword": "berapa harga?",
    "response": "Harga untuk Salepage Premium Lifetime ni cuma **RM150** sahaja, {{name}}. Bayar sekali, guna sampai bila-bila! ðŸ¤© Memang pelaburan yang sangat berbaloi untuk bisnes anda.\n\n|||\n\nDengan pakej ni, anda boleh dapatkan salepage lifetime anda, belajar bina salepage mudah dan percuma atau dapatkan servis dari kami sekarang! Jimat banyak sangat ni, tak perlu pening fikir yuran bulanan lagi.ðŸš€\n\n|||\n\n\n\n|||",
    "attachments": [
      {
        "id": 1764945300015.913,
        "url": "https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/salepage-premium.webp"
      }
    ],
    "buttons": [
      {
        "id": 1764945292914.4443,
        "label": "Dapatkan Salepage Premium Lifetime Sekarang!",
        "url": "https://shop.rakankongsi.com/",
        "isSalepageLink": true
      }
    ]
  },
  {
    "id": 1764854110150.3457,
    "keyword": "salepage premium",
    "response": "Waalaikumussalam dan terima kasih! Nampaknya anda berminat dengan **Salepage Premium Lifetime** kami. ðŸ˜\n\nIni adalah solusi 'killer' untuk jimatkan kos marketing anda secara total. Bayangkan, dengan hanya sekali bayaran, anda dapat akses seumur hidup! Tak perlu pening kepala fikir pasal yuran bulanan atau tahunan lagi. Anda boleh belajar bina salepage yang *high-converting* dengan mudah atau dapatkan servis terus dari kami.\n\nPeluang emas macam ni jarang datang selalu. Dapatkan akses sekarang untuk pastikan bisnes anda nampak lebih profesional dan jualan mencanak naik! Jangan tunggu lama-lama, takut harga promosi ni tamat bila-bila masa je. ðŸ”¥\n\nHarga: RM150 (Lifetime)\n\n|||\n\n\n\n|||",
    "attachments": [
      {
        "url": "https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/salepage-premium.webp",
        "id": 1764854110150.951
      }
    ],
    "buttons": [
      {
        "id": 1764854110150.2012,
        "label": "Lihat Salepage Premium Lifetime",
        "url": "https://shop.rakankongsi.com/",
        "isSalepageLink": true
      },
      {
        "id": 1764854113339,
        "label": "Butang Baru",
        "actionType": "checkout"
      },
      {
        "id": 1764945300015.909,
        "label": "berapa harga?",
        "actionType": "url",
        "triggeredRuleId": 1764945300015.6758
      }
    ]
  }
],
        products: [
  {
    "id": 1762686842699,
    "name": "Biolink Premium",
    "link": "https://shop.rakankongsi.com/",
    "description": "biolink adalah platform di mana anda boleh membina biolink anda sendiri dan gunakan domain anda sendiri.",
    "price": "Rm39",
    "imageUrl": "https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/biolink-premium.webp",
    "customFields": [
      {
        "id": 1,
        "key": "subdomain",
        "label": "Pilihan Subdomain",
        "type": "text",
        "required": true
      },
      {
        "id": 2,
        "key": "email",
        "label": "Alamat Emel",
        "type": "text",
        "required": true
      }
    ]
  },
  {
    "id": 1762686843247,
    "name": "Salepage Premium Lifetime",
    "link": "https://shop.rakankongsi.com/",
    "description": "dapatkan salepage lifetime anda, belajar bina salepage mudah dan percuma atau dapatkan servis dari kami sekarang!",
    "price": "RM150",
    "imageUrl": "https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/salepage-premium.webp",
    "customFields": [
      {
        "id": 1,
        "key": "subdomain",
        "label": "Pilihan Subdomain",
        "type": "text",
        "required": true
      },
      {
        "id": 2,
        "key": "email",
        "label": "Alamat Emel",
        "type": "text",
        "required": true
      }
    ]
  },
  {
    "id": 1762686843656,
    "name": "Chatbot Ai",
    "link": "https://shop.rakankongsi.com/",
    "description": "chatbot ai adalah chatbot ai yang boleh belajar dari database untuk menjawab soalan customer anda.",
    "price": "RM350",
    "imageUrl": "https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/chatbot-ai.webp",
    "customFields": [
      {
        "id": 1,
        "key": "subdomain",
        "label": "Pilihan Subdomain",
        "type": "text",
        "required": true
      },
      {
        "id": 2,
        "key": "email",
        "label": "Alamat Emel",
        "type": "text",
        "required": true
      }
    ]
  },
  {
    "id": 1764414997286,
    "name": "Servis Design",
    "link": "https://shop.rakankongsi.com/",
    "description": "ðŸŽ¨ Pakej 1: Design Produk / Poster Iklan Harga: RM35 sahaja Sesuai untuk: Usahawan baru, peniaga Shopee/TikTok, dan kempen FB Ads.  Jangan biarkan produk bagus anda tenggelam kerana gambar yang hambar. Dapatkan rekaan visual yang bukan sahaja cantik, tetapi menjual. Dengan harga serendah RM35, kami ubah gambar produk biasa menjadi aset pemasaran yang memukau.  Apa yang anda dapat:  âœ… High-Impact Design: Rekaan yang menonjol dalam newsfeed pelanggan.  âœ… Teks & Tipografi Menarik: Susunan ayat (headline) yang mudah dibaca dan menarik perhatian.  âœ… Format Pelbagai: Sesuai untuk Instagram (Square) atau Story (Portrait).  âœ… Siap Cepat: Serahan pantas dalam masa 24-48 jam.  \"Design yang power adalah langkah pertama untuk stop scrolling dan mula membeli.\"  |||ðŸš€ Pakej 2: Premium Sales Page (Minisite) Harga: RM150 sahaja Sesuai untuk: Pelancaran produk, ejen/stokis, dan pengumpulan database.  Tukar pelawat menjadi pembeli dengan Sales Page yang kelihatan profesional dan meyakinkan. Lupakan design yang serabut; kami bina halaman jualan yang kemas, mobile-friendly, dan disusun khas untuk memaksimumkan kadar penukaran (conversion rate).  Kenapa perlu ambil pakej ini?  ðŸŒŸ Kredibiliti Tinggi: Design premium yang membuatkan jenama anda nampak mahal dan dipercayai.  ðŸ“± Mesra Telefon Pintar: Paparan yang optimum di skrin telefon (tempat majoriti pembeli berada).  eye-Flow Jualan Teratur: Susunan gambar, testimoni, dan butang 'Beli' yang strategik.  âš¡ Ringan & Pantas: Design yang tidak membebankan loading website anda.  Nota: Harga untuk design sahaja (format imej/HTML slice mengikut persetujuan).  |||ðŸ¤– Pakej 3: AI Chatbot Pintar Harga: RM299 (Sekali Bayar) Sesuai untuk: Bisnes yang sibuk, customer service, dan automasi jualan.  Penat membalas WhatsApp soalan yang sama berulang kali? Biarkan AI Chatbot kami bekerja untuk anda 24 jam sehari tanpa henti. Menggunakan teknologi kecerdasan buatan (AI) terkini, chatbot ini bukan sekadar robot butang, tetapi mampu \"memahami\" dan melayan pelanggan dengan bahasa yang natural.  Kelebihan Utama:  ðŸ¤– Respon Pantas & Tepat: Menjawab soalan lazim (FAQ) pelanggan serta-merta.  ðŸŒ™ Beroperasi 24/7: 'Close sale' walaupun anda sedang tidur atau bercuti.  ðŸ§  Teknologi AI Pintar: Menggunakan enjin bahasa canggih untuk interaksi yang lebih 'manusia'.  ðŸ“ˆ Jimat Kos Staff: Tidak perlu gajikan admin tambahan untuk kerja menjawab soalan asas.",
    "price": "ikut harga di deskripsi",
    "imageUrl": "https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/design-pro.webp",
    "customFields": [
      {
        "id": 1,
        "key": "subdomain",
        "label": "Pilihan Subdomain",
        "type": "text",
        "required": true
      },
      {
        "id": 2,
        "key": "email",
        "label": "Alamat Emel",
        "type": "text",
        "required": true
      }
    ]
  }
],
        productForms: {
  "Biolink Premium": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ],
  "biolink premium": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ],
  "Salepage Premium Lifetime": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ],
  "salepage premium lifetime": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ],
  "Chatbot Ai": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ],
  "chatbot ai": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ],
  "Servis Design": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ],
  "servis design": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ]
},
        businessInfo: {
  "waktuOperasi": "20 jam berkerja",
  "alamat": "Area Puncak Jalil",
  "maklumatHubungi": "Boleh hubungi kami di 0172255040",
  "mediaSosial": "#rakankongsi",
  "infoPenghantaran": "Selalunya penghantaran akan melalui online email atau whatsapp",
  "polisiPemulangan": "Kami akan refund jika alasan anda munasabah",
  "whatsappNumber": "",
  "wazeLink": "",
  "googleMapsLink": ""
},
        hybridConfig: {
  "enableLogic": true,
  "vagueTriggers": [
    {
      "id": 1,
      "keywords": "saya nak, nak order, berminat",
      "response": "Boleh tuan/puan. Boleh saya tahu tuan/puan berminat dengan produk yang mana satu?"
    },
    {
      "id": 2,
      "keywords": "hi, hello, salam",
      "response": "Waalaikumussalam dan Hai! Selamat datang ke kedai kami. Boleh saya bantu anda cari produk?"
    }
  ],
  "intentRules": [
    {
      "id": 1,
      "keywords": "harga, berapa, kos, rm",
      "intentContext": "User sedang bertanya tentang harga. Sila senaraikan harga produk dengan jelas."
    },
    {
      "id": 2,
      "keywords": "lokasi, mana, kedai, alamat",
      "intentContext": "User ingin tahu lokasi fizikal. Berikan alamat penuh dan info waktu operasi."
    }
  ],
  "fallbackMessage": "Maaf, saya kurang jelas dengan soalan tersebut. Boleh tuan/puan berikan maklumat lanjut tentang produk yang dicari?"
},
        typingDelay: 2500,
        systemPrompt: "Anda adalah pembantu maya profesional untuk perniagaan ini. Tugas anda adalah menjawab soalan pelanggan dengan mesra dalam Bahasa Melayu Malaysia (Baku atau santai). Rujuk senarai produk yang diberikan untuk maklumat harga dan stok. Elakkan menggunakan perkataan Indonesia seperti 'bisa', 'kapan', atau 'toko'. Gunakan 'boleh', 'bila', dan 'kedai'. pastikan penerangan mengenai produk mempunyai elemen hook yang menarik untuk membuatkan customer terasa urgency dan ingin dapatkan secepat mungkin",
        bubbleStyle: "doodle",
        googleAppsScriptUrl: ""
    };

    /* === STATE === */
    let state = {
        collectedVariables: {},
        currentVariableIndex: 0,
        mode: CONFIG.variables.length > 0 ? 'collecting' : 'chatting',
        history: [],
        isLoading: false
    };

    /* === DOM ELEMENTS === */
    const dom = {
        chatBody: document.getElementById('chat-body'),
        inputField: document.getElementById('user-input'),
        sendBtn: document.getElementById('send-btn'),
        introModal: document.getElementById('variable-modal'),
        checkoutModal: document.getElementById('checkout-modal'),
        checkoutInputs: document.getElementById('checkout-inputs-container'),
        checkoutProductInput: document.getElementById('checkout_product_name'),
        introForm: document.getElementById('variable-form'),
        quickReplies: document.getElementById('quick-replies')
    };

    /* === HELPER: Send to Google Sheet (Lite Mode) === */
    async function sendToGoogleSheet(data) {
        if(CONFIG.deploymentType !== 'static_js' || !CONFIG.googleAppsScriptUrl) return;
        try {
            console.log("Sending data to sheet:", data);
            // Using no-cors to avoid CORS errors with some Apps Script deployments.
            await fetch(CONFIG.googleAppsScriptUrl, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            console.log("Data sent to sheet (Lite Mode)");
        } catch(e) {
            console.error("Sheet Error:", e);
        }
    }

    /* === UI FUNCTIONS === */
    function scrollToBottom() {
        dom.chatBody.scrollTop = dom.chatBody.scrollHeight;
    }

    function showTypingIndicator() {
        if(state.isLoading) return;
        state.isLoading = true;
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = 'flex items-start gap-2.5 max-w-[85%] animate-fade-in';
        
        let bubbleClass = 'p-3 rounded-2xl bg-bot-bubble text-bot-text';
        if(CONFIG.bubbleStyle === 'pixel') bubbleClass += ' bubble-pixel bubble-bot-pixel';
        else if(CONFIG.bubbleStyle === 'doodle') bubbleClass += ' bubble-doodle-bot';
        else if(CONFIG.bubbleStyle === 'custom') bubbleClass += ' bubble-custom bubble-custom-bot';
        else bubbleClass += ' bubble-std bubble-std-bot';

        typingDiv.innerHTML = `
            <div class="flex-shrink-0 h-8 w-8 rounded-full bg-gray-200 overflow-hidden bg-cover bg-center" style="background-image: url('https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/Avatar.webp');">
                
            </div>
            <div class="${bubbleClass} flex items-center gap-1 shadow-sm">
                <span class="text-xs opacity-75 mr-1 italic">Sedang menaip</span>
                <div class="w-1.5 h-1.5 bg-current rounded-full animate-bounce"></div>
                <div class="w-1.5 h-1.5 bg-current rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-1.5 h-1.5 bg-current rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
        `;
        dom.chatBody.appendChild(typingDiv);
        scrollToBottom();
    }

    function removeTypingIndicator() {
        const el = document.getElementById('typing-indicator');
        if(el) el.remove();
        state.isLoading = false;
    }

    function addMessage(role, text, attachments = []) {
        const row = document.createElement('div');
        row.className = `flex items-start gap-2.5 max-w-[90%] animate-fade-in ${role === 'user' ? 'flex-row-reverse self-end' : 'self-start'}`;
        
        const avatar = document.createElement('div');
        avatar.className = `flex-shrink-0 h-8 w-8 rounded-full overflow-hidden bg-cover bg-center flex items-center justify-center ${role === 'bot' ? 'bg-gray-200' : 'bg-primary'}`;
        if (role === 'bot') {
            avatar.style.backgroundImage = "url('https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/Avatar.webp')";
            if (!"https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/Avatar.webp") avatar.innerHTML = "ðŸ¤–";
        } else {
            avatar.innerHTML = '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>';
        }

        if(text === '[[FORM_TRIGGER]]') {
             const btn = document.createElement('button');
             btn.textContent = "Mula Chat";
             btn.className = "bg-primary text-white font-bold py-2.5 px-6 shadow-lg hover:scale-105 transition-transform text-sm uppercase tracking-wide border-2 border-white/20";
             
             if(CONFIG.bubbleStyle === 'pixel') btn.style.border = '4px solid #000';
             else if(CONFIG.bubbleStyle === 'doodle') btn.style.borderRadius = '255px 15px 225px 15px/15px 225px 15px 255px';
             else btn.style.borderRadius = '9999px';

             btn.onclick = () => { dom.introModal.classList.remove('hidden'); dom.introModal.classList.add('flex'); };
             
             if(role === 'bot') {
                row.appendChild(avatar);
                row.appendChild(btn);
             } else {
                row.appendChild(btn);
             }
             dom.chatBody.appendChild(row);
             scrollToBottom();
             return;
        }

        const bubble = document.createElement('div');
        let bubbleClass = role === 'user' 
            ? 'bg-user-bubble text-user-text' 
            : 'bg-bot-bubble text-bot-text';
            
        bubbleClass += ' p-3 text-sm md:text-base break-words'; 

        if(CONFIG.bubbleStyle === 'pixel') {
            bubbleClass += role === 'user' ? ' bubble-pixel bubble-user-pixel' : ' bubble-pixel bubble-bot-pixel';
        } else if(CONFIG.bubbleStyle === 'doodle') {
            bubbleClass += role === 'user' ? ' bubble-doodle-user' : ' bubble-doodle-bot';
        } else if(CONFIG.bubbleStyle === 'custom') {
            bubbleClass += role === 'user' ? ' bubble-custom bubble-custom-user' : ' bubble-custom bubble-custom-bot';
        } else {
            bubbleClass += role === 'user' ? ' bubble-std bubble-std-user' : ' bubble-std bubble-std-bot';
        }
        
        bubble.className = bubbleClass;

        let formattedText = text
            .replace(/</g, "&lt;").replace(/>/g, "&gt;")
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/~(.*?)~/g, '<del>$1</del>')
            .replace(/\n/g, '<br>');
            
        const urlRegex = /(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp))/gi;
        formattedText = formattedText.replace(urlRegex, '<img src="$1" class="rounded-lg mt-2 max-w-full cursor-pointer hover:opacity-90 transition shadow-sm" onclick="window.open(\'$1\', \'_blank\')" />');

        bubble.innerHTML = formattedText;
        
        if(attachments && attachments.length > 0) {
            attachments.forEach(att => {
                if(att.url) {
                    const img = document.createElement('img');
                    img.src = att.url;
                    img.className = 'rounded-lg mt-2 max-w-full cursor-pointer hover:opacity-90 transition shadow-sm';
                    img.onclick = () => window.open(att.url, '_blank');
                    bubble.appendChild(img);
                }
            });
        }

        if(role === 'bot') {
            row.appendChild(avatar);
            row.appendChild(bubble);
        } else {
            row.appendChild(bubble);
        }
        
        dom.chatBody.appendChild(row);
        scrollToBottom();
    }

    function setQuickReplies(buttons) {
        dom.quickReplies.innerHTML = '';
        if(!buttons || buttons.length === 0) return;
        
        buttons.forEach(btn => {
            const el = document.createElement('button');
            let btnClass = "flex-shrink-0 px-4 py-2 text-sm font-medium transition-all transform hover:-translate-y-0.5 shadow-md border border-white/50 text-gray-800 bg-white/90 backdrop-blur-sm hover:bg-white rounded-full whitespace-nowrap";
            
            if(btn.isSalepageLink) {
                btnClass = "flex-shrink-0 px-5 py-2.5 text-sm font-bold text-white rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all animate-salepage border border-white/20 whitespace-nowrap";
                el.style.background = "linear-gradient(45deg, #00a884, #a855f7)";
            } else {
                if(CONFIG.bubbleStyle === 'pixel') { btnClass = btnClass.replace('rounded-full', 'rounded-none border-2 border-black shadow-none'); }
            }

            el.className = btnClass;
            el.textContent = btn.label;
            
            if(btn.actionType === 'checkout') {
                el.onclick = () => openCheckoutModal(btn.checkoutPayload || btn.label);
            } else if(btn.url) {
                el.onclick = () => window.open(btn.url, '_blank');
            } else {
                el.onclick = () => handleUserInput(btn.label);
            }
            dom.quickReplies.appendChild(el);
        });
        scrollToBottom();
    }

    // Logic Engine
    function replacePlaceholders(text) {
        let res = text;
        for(let key in state.collectedVariables) { res = res.replace(new RegExp('{{'+key+'}}', 'g'), state.collectedVariables[key]); }
        for(let key in CONFIG.businessInfo) { res = res.replace(new RegExp('{{'+key+'}}', 'g'), CONFIG.businessInfo[key]); }
        CONFIG.products.forEach((p, i) => { res = res.replace(new RegExp('{{product_'+(i+1)+'_link}}', 'g'), p.link); });
        return res;
    }

    async function processStaticRules(input) {
        const lower = input.toLowerCase();
        const matched = CONFIG.autoResponderRules.find(r => {
            const kws = r.keyword.toLowerCase().split(',').map(k => k.trim()).filter(Boolean);
            return kws.some(k => lower.includes(k));
        });
        if(matched) {
            return { text: replacePlaceholders(matched.response), attachments: matched.attachments, buttons: matched.buttons };
        }
        
        const matchedProd = CONFIG.products.find(p => lower.includes(p.name.toLowerCase()));
        if(matchedProd) {
             const buttons = [{ label: "Beli " + matchedProd.name, actionType: 'checkout', checkoutPayload: matchedProd.name }];
             if(matchedProd.link) buttons.unshift({ label: "Lihat Info Lanjut", url: matchedProd.link, isSalepageLink: true });
             let txt = "Saya menjumpai produk: **" + matchedProd.name + "**\n";
             if(matchedProd.description) txt += matchedProd.description + "\n";
             if(matchedProd.price) txt += "Harga: " + matchedProd.price;
             const att = matchedProd.imageUrl ? [{url: matchedProd.imageUrl}] : [];
             return { text: txt, attachments: att, buttons: buttons };
        }
        
        if(CONFIG.deploymentType === 'static_js') {
             if(CONFIG.enableStaticApi && CONFIG.apiKeys.length > 0 && CONFIG.apiKeys[0]) {
                 return await callGroqDirect(input);
             }
             return { text: CONFIG.hybridConfig.fallbackMessage || "Maaf, saya tidak faham. Sila pilih menu.", buttons: [] };
        } else {
             return await callPhpApi(input);
        }
    }
    
    async function callGroqDirect(input) {
        try {
            const apiKey = CONFIG.apiKeys[0];
            const messages = [
                { role: "system", content: CONFIG.systemPrompt + "\n\n[DATA USER]\n" + JSON.stringify(state.collectedVariables) + "\n\nGunakan '|||' untuk memisahkan perenggan." },
                ...state.history.slice(-6),
                { role: "user", content: input }
            ];
            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Bearer " + apiKey },
                body: JSON.stringify({ messages: messages, model: CONFIG.model, temperature: 0.7, max_tokens: 1000 })
            });
            const data = await response.json();
            if(data.choices && data.choices[0]) {
                let content = data.choices[0].message.content;
                if(content.includes('[[CHECKOUT:')) {
                     const match = content.match(/\[\[CHECKOUT:\s*(.*?)\]\]/);
                     if(match) { setTimeout(() => openCheckoutModal(match[1]), 1500); content = content.replace(match[0], ''); }
                }
                return { text: content, buttons: [] };
            }
            return { text: "Ralat sambungan AI.", buttons: [] };
        } catch(e) {
            return { text: "Ralat kritikal: " + e.message, buttons: [] };
        }
    }
    
    async function callPhpApi(input) {
        try {
            const payload = {
                action: 'chat',
                messages: [...state.history.slice(-10), { role: 'user', content: input }],
                collectedVariables: state.collectedVariables
            };
            const res = await fetch('api.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if(data.choices && data.choices[0]) {
                const content = data.choices[0].message.content;
                return { 
                    text: content, 
                    buttons: data.custom_data?.buttons || [] 
                };
            }
            return { text: "Tiada respons.", buttons: [] };
        } catch(e) {
            return { text: "Ralat pelayan: " + e.message, buttons: [] };
        }
    }

    async function handleUserInput(text) {
        if(!text) return;
        removeTypingIndicator();
        addMessage('user', text);
        state.history.push({role:'user', content:text});
        dom.inputField.value = '';
        dom.inputField.focus();
        setQuickReplies([]);
        
        // INTRO FLOW CHECK
        if(state.mode === 'collecting' && CONFIG.variableCollectionStyle === 'chat') {
            const currentVar = CONFIG.variables[state.currentVariableIndex];
            state.collectedVariables[currentVar.variableKey] = text;
            state.currentVariableIndex++;
            
            showTypingIndicator();
            await new Promise(r => setTimeout(r, 600));
            removeTypingIndicator();
            
            if(state.currentVariableIndex < CONFIG.variables.length) {
                addMessage('bot', CONFIG.variables[state.currentVariableIndex].question);
            } else {
                state.mode = 'chatting';
                await sendToGoogleSheet({
                   type: 'Lead / Intro (Chat)',
                   ...state.collectedVariables
                });
                
                const welcome = replacePlaceholders(CONFIG.welcomeMessage);
                addMessage('bot', welcome);
                setQuickReplies(CONFIG.introButtons);
            }
            return;
        }

        showTypingIndicator();
        
        setTimeout(async () => {
            const result = await processStaticRules(text);
            removeTypingIndicator();
            
            const chunks = result.text.split('|||').filter(c => c.trim());
            for(let i=0; i<chunks.length; i++) {
                addMessage('bot', chunks[i], (i===chunks.length-1) ? result.attachments : []);
                if(i < chunks.length-1) await new Promise(r => setTimeout(r, 400));
            }
            state.history.push({role:'assistant', content:result.text});
            setQuickReplies(result.buttons);
            
        }, CONFIG.typingDelay);
    }
    
    function openCheckoutModal(productName) {
        dom.checkoutProductInput.value = productName || 'Produk Umum';
        dom.checkoutModal.classList.remove('hidden');
        dom.checkoutModal.classList.add('flex');
    }

    /* === INITIALIZATION === */
    dom.sendBtn.onclick = () => handleUserInput(dom.inputField.value);
    dom.inputField.onkeydown = (e) => { if(e.key === 'Enter') handleUserInput(dom.inputField.value); };
    
    if(dom.introForm) {
        dom.introForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(dom.introForm);
            const data = {};
            formData.forEach((value, key) => data[key] = value);
            
            state.collectedVariables = { ...state.collectedVariables, ...data };
            state.mode = 'chatting';
            
            await sendToGoogleSheet({ type: 'Lead / Intro Form', ...data });

            dom.introModal.classList.add('hidden');
            dom.introModal.classList.remove('flex');
            
            const welcome = replacePlaceholders(CONFIG.welcomeMessage);
            addMessage('bot', welcome);
            setQuickReplies(CONFIG.introButtons);
            
            if(CONFIG.deploymentType === 'php_api') {
                fetch('api.php', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'intro_submit', collectedVariables: data }) });
            }
        });
    }

    const checkoutForm = dom.checkoutModal.querySelector('form');
    if(checkoutForm) {
        checkoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(checkoutForm);
            const data = { type: 'Tempahan / Checkout' };
            formData.forEach((value, key) => data[key] = value);
            
            await sendToGoogleSheet(data);

            dom.checkoutModal.classList.add('hidden');
            dom.checkoutModal.classList.remove('flex');
            
            addMessage('bot', "Terima kasih! Tempahan anda untuk " + (data.product || 'produk') + " telah direkodkan. Kami akan hubungi anda sebentar lagi.");
            
             if(CONFIG.deploymentType === 'php_api') {
                fetch('api.php', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'checkout', ...data }) });
            }
        });
    }
    
    if(state.mode === 'collecting' && CONFIG.variableCollectionStyle === 'chat') {
        addMessage('bot', CONFIG.variables[0].question);
    } else if(state.mode === 'collecting' && CONFIG.variableCollectionStyle === 'form') {
         if(CONFIG.variableIntro) addMessage('bot', CONFIG.variableIntro);
         addMessage('bot', '[[FORM_TRIGGER]]');
    } else {
        addMessage('bot', CONFIG.welcomeMessage);
        setQuickReplies(CONFIG.introButtons);
    }
    
    </script>
</body>
</html>