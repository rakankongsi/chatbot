
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>RK Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ... (CSS Styles) ... */
        :root { --primary-color: #00a884; --font-family: 'Roboto', sans-serif; }
        body { font-family: var(--font-family); margin:0; padding:0; background: transparent; }
        .modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: #fff; width: 90%; max-width: 400px; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { background: var(--primary-color); color: #fff; padding: 15px; display: flex; justify-content: space-between; }
        .modal-body-scroll { padding: 20px; overflow-y: auto; }
        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; }
        .form-group label { font-size: 0.9em; font-weight: bold; margin-bottom: 5px; }
        .form-group input, .form-group textarea { padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .submit-btn { width: 100%; padding: 12px; background: var(--primary-color); color: #fff; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .payment-info { background: #f9fafb; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em; white-space: pre-wrap; }
        .qr-container { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 15px; }
        .qr-image { max-width: 150px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 8px; }
        .qr-download-btn { display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; background: #f3f4f6; color: #374151; border-radius: 6px; text-decoration: none; font-size: 0.85em; font-weight: 600; border: 1px solid #d1d5db; transition: background 0.2s; }
        .qr-download-btn:hover { background: #e5e7eb; }
        .qr-download-btn svg { width: 16px; height: 16px; }
    </style>
</head>
<body>
    <div id="chat-window">
        <div class="chat-body" id="chat-body"></div>
        
    </div>
    
        <div id="variable-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header"><h3>Maklumat Diri</h3><button type="button" id="close-modal" class="close-btn">&times;</button></div>
                <div class="modal-body-scroll"><form id="variable-form"><div class="form-group"><label for="name">Nama</label><input type="text" id="name" name="name" required></div><button type="submit" class="submit-btn">Hantar</button></form></div>
            </div>
        </div>
    
        <div id="checkout-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="checkout-title">Tempahan Produk</h3>
                    <button type="button" id="close-checkout-modal" class="close-btn">&times;</button>
                </div>
                <div class="modal-body-scroll">
                    <div class="payment-info"><p>Maybank: (ARG EMPIRE)</p></div>
                    
        <div class="qr-container">
            <img src="https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/ARG%20QR.webp" alt="QR Code" class="qr-image" />
            <a href="https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/ARG%20QR.webp" download="qr_code_payment.png" target="_blank" class="qr-download-btn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Muat Turun QR
            </a>
        </div>
                    <div id="checkout-dynamic-fields"></div>
                    <form id="checkout-form">
                        <input type="hidden" name="product_name" id="checkout_product_name">
                        <div id="checkout-inputs-container"></div>
                        <button type="submit" class="submit-btn">Sahkan Tempahan</button>
                    </form>
                </div>
            </div>
        </div>

    <script>
    const productForms = {
  "Biolink Premium": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ],
  "biolink premium": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ],
  "Salepage Premium Lifetime": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ],
  "salepage premium lifetime": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ],
  "Chatbot Ai": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ],
  "chatbot ai": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ],
  "Servis Design": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ],
  "servis design": [
    {
      "id": 1,
      "key": "subdomain",
      "label": "Pilihan Subdomain",
      "type": "text",
      "required": true
    },
    {
      "id": 2,
      "key": "email",
      "label": "Alamat Emel",
      "type": "text",
      "required": true
    }
  ]
};
    const activeVariables = [
  {
    "question": "Boleh saya dapatkan nama anda?",
    "variableKey": "name",
    "label": "Nama",
    "allowMultiple": false
  }
];
    
    
    // Fungsi untuk menambah input berbilang
    window.addMultiInput = function(containerId, name, type, placeholderBase) {
        const container = document.getElementById(containerId);
        const count = container.querySelectorAll('input').length + 1;
        const input = document.createElement('input');
        input.type = type;
        input.name = name + '[]'; 
        input.placeholder = placeholderBase + ' ' + count;
        input.style.marginTop = '8px';
        container.appendChild(input);
    };

    function generateFieldsHtml(fields, prefix) {
        if (!fields || fields.length === 0) return '<p style="text-align:center; color:#666; font-size:0.9em; padding:20px;">Tiada maklumat tambahan diperlukan untuk produk ini. Sila tekan butang sahkan.</p>';
        return fields.map(v => {
            let inputType = 'text';
            if (v.key && (v.key.includes('email'))) inputType = 'email';
            else if (v.key && (v.key.includes('phone') || v.key.includes('tel'))) inputType = 'tel';
            else if (v.type === 'file') inputType = 'file';
            
            const key = v.key;
            const label = v.label;
            const isRequired = v.required !== false;
            
            // Handle Multiple Inputs (Text only primarily)
            if (v.allowMultiple && v.type === 'text') {
                const containerId = 'multi_' + prefix + key;
                return `
                <div class="form-group">
                    <label for="${prefix}${key}">${label} ${isRequired ? '*' : ''}</label>
                    <div id="${containerId}">
                        <input type="${inputType}" id="${prefix}${key}" name="${key}[]" placeholder="${label} 1" ${isRequired ? 'required' : ''}>
                    </div>
                    <button type="button" 
                        onclick="addMultiInput('${containerId}', '${key}', '${inputType}', '${label}')"
                        style="margin-top:5px; font-size:0.85em; color:var(--primary-color); background:none; border:none; cursor:pointer; font-weight:600; text-align:left; padding:0;">
                        + Tambah ${label}
                    </button>
                </div>`;
            }
            
            if (inputType === 'file') {
                return `<div class="form-group"><label for="${prefix}${key}">${label} ${isRequired ? '*' : ''}</label><input type="file" id="${prefix}${key}" name="${key}" accept="image/*,application/pdf" ${isRequired ? 'required' : ''}><input type="hidden" name="${key}_base64" id="${prefix}${key}_base64"></div>`;
            }
            if (v.type === 'textarea') {
                 return `<div class="form-group"><label for="${prefix}${key}">${label} ${isRequired ? '*' : ''}</label><textarea id="${prefix}${key}" name="${key}" rows="3" placeholder="${label}" ${isRequired ? 'required' : ''}></textarea></div>`;
            }
            return `<div class="form-group"><label for="${prefix}${key}">${label} ${isRequired ? '*' : ''}</label><input type="${inputType}" id="${prefix}${key}" name="${key}" placeholder="${label}" ${isRequired ? 'required' : ''}></div>`;
        }).join('');
    }
    
    
    
        function getCurrentTurnstileToken() { return ''; }
        function resetTurnstile() {}
    

    
        // === STATIC BRAIN LOGIC ===
        const STATIC_RULES = [
  {
    "id": 1764945300015.6758,
    "keyword": "berapa harga?",
    "response": "Harga untuk Salepage Premium Lifetime ni cuma **RM150** sahaja, {{name}}. Bayar sekali, guna sampai bila-bila! ðŸ¤© Memang pelaburan yang sangat berbaloi untuk bisnes anda.\n\n|||\n\nDengan pakej ni, anda boleh dapatkan salepage lifetime anda, belajar bina salepage mudah dan percuma atau dapatkan servis dari kami sekarang! Jimat banyak sangat ni, tak perlu pening fikir yuran bulanan lagi.ðŸš€\n\n|||\n\n\n\n|||",
    "attachments": [
      {
        "id": 1764945300015.913,
        "url": "https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/salepage-premium.webp"
      }
    ],
    "buttons": [
      {
        "id": 1764945292914.4443,
        "label": "Dapatkan Salepage Premium Lifetime Sekarang!",
        "url": "https://shop.rakankongsi.com/",
        "isSalepageLink": true
      }
    ]
  },
  {
    "id": 1764854110150.3457,
    "keyword": "salepage premium",
    "response": "Waalaikumussalam dan terima kasih! Nampaknya anda berminat dengan **Salepage Premium Lifetime** kami. ðŸ˜\n\nIni adalah solusi 'killer' untuk jimatkan kos marketing anda secara total. Bayangkan, dengan hanya sekali bayaran, anda dapat akses seumur hidup! Tak perlu pening kepala fikir pasal yuran bulanan atau tahunan lagi. Anda boleh belajar bina salepage yang *high-converting* dengan mudah atau dapatkan servis terus dari kami.\n\nPeluang emas macam ni jarang datang selalu. Dapatkan akses sekarang untuk pastikan bisnes anda nampak lebih profesional dan jualan mencanak naik! Jangan tunggu lama-lama, takut harga promosi ni tamat bila-bila masa je. ðŸ”¥\n\nHarga: RM150 (Lifetime)\n\n|||\n\n\n\n|||",
    "attachments": [
      {
        "url": "https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/salepage-premium.webp",
        "id": 1764854110150.951
      }
    ],
    "buttons": [
      {
        "id": 1764854110150.2012,
        "label": "Lihat Salepage Premium Lifetime",
        "url": "https://shop.rakankongsi.com/",
        "isSalepageLink": true
      },
      {
        "id": 1764854113339,
        "label": "Butang Baru",
        "actionType": "checkout"
      },
      {
        "id": 1764945300015.909,
        "label": "berapa harga?",
        "actionType": "url",
        "triggeredRuleId": 1764945300015.6758
      }
    ]
  }
];
        const STATIC_PRODUCTS = [
  {
    "id": 1762686842699,
    "name": "Biolink Premium",
    "link": "https://shop.rakankongsi.com/",
    "description": "biolink adalah platform di mana anda boleh membina biolink anda sendiri dan gunakan domain anda sendiri.",
    "price": "Rm39",
    "imageUrl": "https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/biolink-premium.webp",
    "customFields": [
      {
        "id": 1,
        "key": "subdomain",
        "label": "Pilihan Subdomain",
        "type": "text",
        "required": true
      },
      {
        "id": 2,
        "key": "email",
        "label": "Alamat Emel",
        "type": "text",
        "required": true
      }
    ]
  },
  {
    "id": 1762686843247,
    "name": "Salepage Premium Lifetime",
    "link": "https://shop.rakankongsi.com/",
    "description": "dapatkan salepage lifetime anda, belajar bina salepage mudah dan percuma atau dapatkan servis dari kami sekarang!",
    "price": "RM150",
    "imageUrl": "https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/salepage-premium.webp",
    "customFields": [
      {
        "id": 1,
        "key": "subdomain",
        "label": "Pilihan Subdomain",
        "type": "text",
        "required": true
      },
      {
        "id": 2,
        "key": "email",
        "label": "Alamat Emel",
        "type": "text",
        "required": true
      }
    ]
  },
  {
    "id": 1762686843656,
    "name": "Chatbot Ai",
    "link": "https://shop.rakankongsi.com/",
    "description": "chatbot ai adalah chatbot ai yang boleh belajar dari database untuk menjawab soalan customer anda.",
    "price": "RM350",
    "imageUrl": "https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/chatbot-ai.webp",
    "customFields": [
      {
        "id": 1,
        "key": "subdomain",
        "label": "Pilihan Subdomain",
        "type": "text",
        "required": true
      },
      {
        "id": 2,
        "key": "email",
        "label": "Alamat Emel",
        "type": "text",
        "required": true
      }
    ]
  },
  {
    "id": 1764414997286,
    "name": "Servis Design",
    "link": "https://shop.rakankongsi.com/",
    "description": "ðŸŽ¨ Pakej 1: Design Produk / Poster Iklan Harga: RM35 sahaja Sesuai untuk: Usahawan baru, peniaga Shopee/TikTok, dan kempen FB Ads.  Jangan biarkan produk bagus anda tenggelam kerana gambar yang hambar. Dapatkan rekaan visual yang bukan sahaja cantik, tetapi menjual. Dengan harga serendah RM35, kami ubah gambar produk biasa menjadi aset pemasaran yang memukau.  Apa yang anda dapat:  âœ… High-Impact Design: Rekaan yang menonjol dalam newsfeed pelanggan.  âœ… Teks & Tipografi Menarik: Susunan ayat (headline) yang mudah dibaca dan menarik perhatian.  âœ… Format Pelbagai: Sesuai untuk Instagram (Square) atau Story (Portrait).  âœ… Siap Cepat: Serahan pantas dalam masa 24-48 jam.  \"Design yang power adalah langkah pertama untuk stop scrolling dan mula membeli.\"  |||ðŸš€ Pakej 2: Premium Sales Page (Minisite) Harga: RM150 sahaja Sesuai untuk: Pelancaran produk, ejen/stokis, dan pengumpulan database.  Tukar pelawat menjadi pembeli dengan Sales Page yang kelihatan profesional dan meyakinkan. Lupakan design yang serabut; kami bina halaman jualan yang kemas, mobile-friendly, dan disusun khas untuk memaksimumkan kadar penukaran (conversion rate).  Kenapa perlu ambil pakej ini?  ðŸŒŸ Kredibiliti Tinggi: Design premium yang membuatkan jenama anda nampak mahal dan dipercayai.  ðŸ“± Mesra Telefon Pintar: Paparan yang optimum di skrin telefon (tempat majoriti pembeli berada).  eye-Flow Jualan Teratur: Susunan gambar, testimoni, dan butang 'Beli' yang strategik.  âš¡ Ringan & Pantas: Design yang tidak membebankan loading website anda.  Nota: Harga untuk design sahaja (format imej/HTML slice mengikut persetujuan).  |||ðŸ¤– Pakej 3: AI Chatbot Pintar Harga: RM299 (Sekali Bayar) Sesuai untuk: Bisnes yang sibuk, customer service, dan automasi jualan.  Penat membalas WhatsApp soalan yang sama berulang kali? Biarkan AI Chatbot kami bekerja untuk anda 24 jam sehari tanpa henti. Menggunakan teknologi kecerdasan buatan (AI) terkini, chatbot ini bukan sekadar robot butang, tetapi mampu \"memahami\" dan melayan pelanggan dengan bahasa yang natural.  Kelebihan Utama:  ðŸ¤– Respon Pantas & Tepat: Menjawab soalan lazim (FAQ) pelanggan serta-merta.  ðŸŒ™ Beroperasi 24/7: 'Close sale' walaupun anda sedang tidur atau bercuti.  ðŸ§  Teknologi AI Pintar: Menggunakan enjin bahasa canggih untuk interaksi yang lebih 'manusia'.  ðŸ“ˆ Jimat Kos Staff: Tidak perlu gajikan admin tambahan untuk kerja menjawab soalan asas.",
    "price": "ikut harga di deskripsi",
    "imageUrl": "https://cdn.jsdelivr.net/gh/rakankongsi/hosting-image@main/design-pro.webp",
    "customFields": [
      {
        "id": 1,
        "key": "subdomain",
        "label": "Pilihan Subdomain",
        "type": "text",
        "required": true
      },
      {
        "id": 2,
        "key": "email",
        "label": "Alamat Emel",
        "type": "text",
        "required": true
      }
    ]
  }
];
        const FALLBACK_MSG = "Maaf, saya kurang jelas dengan soalan tersebut. Boleh tuan/puan berikan maklumat lanjut tentang produk yang dicari?";

        function replacePlaceholders(text, vars) {
            let newText = text;
            for(const key in vars) {
                newText = newText.replace(new RegExp('{{'+key+'}}', 'g'), vars[key]);
            }
            return newText;
        }

        async function processUserMessage(userInput) {
            // 1. Simulate "Thinking" delay
            await new Promise(r => setTimeout(r, 800));

            const lowerInput = userInput.toLowerCase();
            let matchedRule = null;
            let responseText = "";
            let buttons = [];
            let attachments = [];

            // 2. Keyword Matching (Exact or Substring)
            // Priority: Longer keyword matches first to avoid ambiguity
            const sortedRules = STATIC_RULES.sort((a,b) => b.keyword.length - a.keyword.length);
            
            for (const rule of sortedRules) {
                const keywords = (rule.keyword || '').toLowerCase().split(',').map(k => k.trim()).filter(Boolean);
                if (keywords.length > 0 && keywords.some(k => lowerInput.includes(k))) {
                    matchedRule = rule;
                    break;
                }
            }

            if (matchedRule) {
                responseText = matchedRule.response;
                buttons = matchedRule.buttons || [];
                attachments = matchedRule.attachments || [];
            } else {
                // 3. Fallback: Check for Product Names
                const matchedProduct = STATIC_PRODUCTS.find(p => lowerInput.includes(p.name.toLowerCase()));
                if(matchedProduct) {
                    responseText = "Saya menjumpai produk: **" + matchedProduct.name + "**\n" + (matchedProduct.description || "") + "\n\nHarga: " + (matchedProduct.price || "-");
                    if(matchedProduct.imageUrl) attachments.push({url: matchedProduct.imageUrl});
                    // Add Checkout button
                    buttons.push({id: Date.now(), label: "Beli " + matchedProduct.name, actionType: 'checkout', checkoutPayload: matchedProduct.name});
                } else {
                    responseText = FALLBACK_MSG;
                }
            }

            // 4. Return formatted response object akin to API
            return {
                choices: [{
                    message: { content: responseText }
                }],
                custom_data: {
                    buttons: buttons,
                    attachments: attachments
                }
            };
        }

        // Mock function for API call, routing to local logic
        window.sendToApi = async function(payload) {
             const userMsg = payload.messages[payload.messages.length - 1].content;
             const result = await processUserMessage(userMsg);
             return result;
        };
        

    document.addEventListener('DOMContentLoaded', () => {
        const checkoutModal = document.getElementById('checkout-modal');
        const inputsContainer = document.getElementById('checkout-inputs-container');
        const productNameInput = document.getElementById('checkout_product_name');
        const checkoutTitle = document.getElementById('checkout-title');
        
        // ... (Standard Chat Logic setup) ...
        // Note: In a real implementation, the full chat UI logic (addMessage, createBubble, etc.) would be injected here.
        // For this specific requested update, we ensure 'sendToApi' is correctly routed.

        window.openCheckoutModal = function(productName) {
            if (!checkoutModal) return;
            const fields = productForms[productName] || productForms[productName.toLowerCase()] || [];
            inputsContainer.innerHTML = generateFieldsHtml(fields, 'checkout_');
            productNameInput.value = productName;
            checkoutTitle.textContent = 'Tempahan: ' + productName;
            
            inputsContainer.querySelectorAll('input[type="file"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    const hiddenId = input.id + '_base64';
                    const hiddenInput = document.getElementById(hiddenId);
                    if (file && hiddenInput) {
                        const reader = new FileReader();
                        reader.onload = function(e) { hiddenInput.value = e.target.result; };
                        reader.readAsDataURL(file);
                    }
                });
            });
            checkoutModal.style.display = 'flex';
        };
        
        document.getElementById('close-checkout-modal')?.addEventListener('click', () => {
            checkoutModal.style.display = 'none';
        });

        document.getElementById('checkout-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};
            formData.forEach((val, key) => {
                if(key.endsWith('[]')) {
                    const cleanKey = key.slice(0, -2);
                    if(!data[cleanKey]) data[cleanKey] = [];
                    data[cleanKey].push(val);
                } else {
                    data[key] = val;
                }
            });
            checkoutModal.style.display = 'none';
            // Here we would call sendToApi with action='checkout'
            // For Static mode, this might just show an alert
            if (typeof sendToApi === 'function') {
                 // Mock sending checkout
                 alert("Tempahan diterima! (Mode: " + ("static_js" === 'static_js' ? "Static" : "API") + ")");
            }
        });
    });
    </script>
</body>
</html>
